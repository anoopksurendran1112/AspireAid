{% extends 'index.html' %}
{% load static %}
{% load humanize %}
{% block content %}

    <section class="mt-5 py-5" id="track-status">
        <div class="container py-5">
            <div class="row d-flex justify-content-center mb-5">
                <div class="col-lg-8 col-md-10">
                    <h1 class="mb-4 text-center display-5 fw-bolder">Track Your Status</h1>
                    <p class="lead text-center text-muted mx-auto mb-5">
                        Enter your <span class="fw-bold text-dark">Tracking ID</span>, <span class="fw-bold text-dark">Phone number</span>, or <span class="fw-bold text-dark">Email ID</span> below to view your transaction history.
                    </p>

                    <form method="post" class="w-75 mx-auto" id="trackForm">
                        {% csrf_token %}
                        <div class="input-group shadow-lg rounded-pill overflow-hidden track-input-group">
                            <input type="text" class="form-control border-0 py-3 ps-4"
                                   placeholder="Tracking ID, Phone number or Email ID"
                                   name="track"
                                   required>
                            <button class="btn btn-primary fw-bold px-4" type="submit">
                                <i class="bi bi-search me-2"></i> Track Status
                            </button>
                        </div>
                        <div id="validationMessage" class="text-danger small mt-2 fw-semibold" style="display: none;"></div>
                    </form>
                </div>
            </div>

            {% if tra %}
            <div class="card shadow-lg border-0 my-5 rounded-4">
                <div class="card-body p-4 p-lg-5">
                    <h3 class="card-title mb-4 text-center fw-bold text-dark">Your Transactions for: {{ search }}</h3>
                    <div class="table-responsive">
                        <table class="table table-striped my-0 align-middle track-status-table">
                            <thead class="table-dark">
                                <tr>
                                    <th>Sl no</th>
                                    <th>Project</th>
                                    <th>Tile Value</th>
                                    <th>Date</th>
                                    <th>Selected Tiles</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for t in tra %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td><a href="/user/{{ ins.id }}/single-project/{{ t.project.id }}/" class="text-primary text-decoration-none fw-semibold">{{ t.project.title }}</a></td>
                                    <td>‚Çπ{{ t.project.tile_value|floatformat:2|intcomma }}</td>
                                    <td>{{ t.transaction_time|date:"M d, Y" }}</td>
                                    <td>{{ t.tiles_bought.tiles }}</td>
                                    <td>{{ t.num_tiles }}</td>
                                    <td>‚Çπ{{ t.amount|floatformat:2|intcomma }}</td>
                                    <td>
                                        {% if t.status == 'Unverified' %}
                                            <span class="badge bg-warning text-dark">{{ t.status }}</span>
                                        {% elif t.status == 'Verified' %}
                                            <span class="badge bg-success">{{ t.status }}</span>
                                        {% else %}
                                            <span class="badge bg-danger">{{ t.status }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="py-5 text-center">
                {% if request.method == 'POST' %}
                    <div class="alert alert-info shadow-sm rounded-3 p-4" role="alert">
                        <h4 class="alert-heading fw-bold mb-3">üîç No transactions found!</h4>
                        <p class="mb-0 text-dark">It seems we couldn't find any donations for the information you entered. Please double-check the details (Tracking ID, Phone, or Email) and try again.</p>
                    </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </section>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('trackForm');
            const trackInput = form.querySelector('[name="track"]');
            const validationMessage = document.getElementById('validationMessage');

            form.addEventListener('submit', function (event) {
                event.preventDefault();
                const inputValue = trackInput.value.trim();

                // Clear previous validation messages and styles
                validationMessage.style.display = 'none';
                trackInput.classList.remove('is-invalid');

                // Regex for 10-digit phone number (exactly 10 digits)
                const phoneRegex = /^\d{10}$/;
                // Regex for basic email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

                // Check for phone number and validate
                if (phoneRegex.test(inputValue)) {
                    // Valid phone number, proceed to submit
                }
                // Check for email and validate
                else if (emailRegex.test(inputValue)) {
                    // Valid email, proceed to submit
                }
                // Check if it looks like a number but is not 10 digits
                else if (/^\d+$/.test(inputValue) && inputValue.length !== 10) {
                     validationMessage.textContent = "Phone number must be exactly 10 digits.";
                     validationMessage.style.display = 'block';
                     trackInput.classList.add('is-invalid');
                     return;
                }
                // Check if it's empty
                 else if (inputValue === '') {
                     validationMessage.textContent = "Please enter your Tracking ID, Phone number, or Email ID.";
                     validationMessage.style.display = 'block';
                     trackInput.classList.add('is-invalid');
                     return;
                 }
                // For tracking ID (we trust the backend validation for format, only check for required field)

                // Submit the form
                form.submit();
            });
        });
    </script>

{% endblock %}