{% extends 'index.html' %}
{% load static %}
{% load humanize %}
{% block content %}

<section class="project-area section-gap" id="project">
    <div class="container">
        <div class="card data-card">
            <div class="card-header text-center">
                <h1 class="my-2"><strong>Upload Proof</strong></h1>
            </div>
            <div class="card-body p-4">

                <div class="row g-4 mb-4">
                    <div class="col-md-12">
                        <div class="card h-100 border-0">
                            <div class="card-body">
                                <h4 class="card-title mb-3">Buyer Details</h4>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                        <strong>Full name:</strong>
                                        <span>{{ tra.sender.first_name }} {{ tra.sender.last_name }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                        <strong>Email:</strong>
                                        <span>{{ tra.sender.email }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                        <strong>Phone:</strong>
                                        <span>{{ tra.sender.phone }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                        <strong>Address:</strong>
                                        <span>{{ tra.sender.address }}</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-dark ">
                                <h4 class="card-title text-white">Project Details</h4>
                            </div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                        <strong>Project:</strong>
                                        <span>{{ tra.project.title }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                        <strong>Target:</strong>
                                        <span>₹{{ tra.project.funding_goal|floatformat:2|intcomma }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                        <strong>Created on:</strong>
                                        <span>{{ tra.project.created_at|date:"F d, Y" }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                        <strong>Closing by:</strong>
                                        <span>{{ tra.project.closing_date|date:"F d, Y" }}</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-dark ">
                                <h4 class="card-title text-white">Beneficiary Details</h4>
                            </div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                        <strong>Name:</strong>
                                        <span>{{ tra.project.beneficiary.first_name }} {{ tra.project.beneficiary.last_name }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                        <strong>Age:</strong>
                                        <span>{{ tra.project.beneficiary.age }} years old</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                        <strong>Phone:</strong>
                                        <span>+91-{{ tra.project.beneficiary.phone_number }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                        <strong>Address:</strong>
                                        <span>{{ tra.project.beneficiary.address }}</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <h4 class="card-title mb-3">Transaction Summary</h4>
                        <div class="table-responsive">
                            <table class="table table-striped align-middle table-nowrap table-centered mb-0">
                                <thead class="bg-dark text-white">
                                    <tr>
                                        <th>Selected Tiles</th>
                                        <th>Tile Value</th>
                                        <th>Quantity</th>
                                        <th class="text-end">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="total-details" data-tile-value="{{ tra.project.tile_value }}" data-count="{{ count }}">
                                    <tr>
                                        <td>
                                            <h6 class="text-truncate font-size-14 mb-1">{{ tra.tiles_bought.tiles }}</h6>
                                        </td>
                                        <td>₹{{ tra.project.tile_value|floatformat:2|intcomma }}</td>
                                        <td>{{ count }}</td>
                                        <td class="text-end text-black">
                                            <strong><span id="calculated-total"></span></strong>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <h4 class="card-title mb-3">Payment Details</h4>
                        <ul class="list-group list-group-flush">
                             <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <strong>Tracking ID:</strong>
                                <strong><span>{{ tra.tracking_id }}</span></strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <strong>Transaction Time:</strong>
                                <span>{{ tra.transaction_time|date:"F d, Y, h:i A" }}</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title mb-3">Upload Proof of Payment</h4>
                        <form id="upload-form" method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="proof-file" class="form-label">Choose File</label>
                                <input type="file" class="form-control" id="proof-file" name="proof_of_payment" accept="image/*,application/pdf" required>
                                <div class="form-text">Accepted formats: images (.jpg, .png, etc.) and PDFs.</div>
                            </div>
                            <div class="text-end">
                                <button type="submit" id="upload-button" class="btn btn-primary" disabled>
                                    Submit Proof
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Total Calculation Logic ---
        const totalSpan = document.getElementById('calculated-total');
        const tbody = document.getElementById('total-details');

        if (tbody && totalSpan) {
            const tileValue = parseFloat(tbody.dataset.tileValue);
            const count = parseInt(tbody.dataset.count);
            const total = tileValue * count;
            totalSpan.textContent = `₹${total.toFixed(2)}`;
        }

        // --- Form Validation & Resubmission Prevention ---
        const uploadForm = document.getElementById('upload-form');
        const uploadButton = document.getElementById('upload-button');
        const proofFile = document.getElementById('proof-file');

        function checkFileSelected() {
            uploadButton.disabled = proofFile.files.length === 0;
        }

        proofFile.addEventListener('change', checkFileSelected);

        uploadForm.addEventListener('submit', () => {
            uploadButton.disabled = true;
            uploadButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...`;
        });
    });

    // --- SweetAlert Messages ---
    {% if messages %}
        {% for message in messages %}
            Swal.fire({
                title: '{{ message.tags|title }}!',
                text: '{{ message }}',
                icon: '{{ message.tags }}',
                confirmButtonText: 'OK'
            });
        {% endfor %}
    {% endif %}
</script>

{% endblock %}