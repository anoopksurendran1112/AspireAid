{% extends 'index.html' %}
{% load static %}
{% load humanize %}
{% block content %}

    <div class="modal fade" id="confirmCheckoutModal" tabindex="-1" aria-labelledby="confirmCheckoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmCheckoutModalLabel"><strong>Confirm and Redirect</strong></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">x</button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to proceed? Your selected tiles will be reserved, and you will be redirected to the project page.</p>
                    <h4>Total: <span class="text-success" id="modal-total">₹0.00</span></h4>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="final-submit-button">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <section class="project-area section-gap" id="project">
        <div class="container">
            <div class="card data-card">
                <div class="card-header text-center bg-info">
                    <h1 class="text-white"><strong>Checkout</strong></h1>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12">
                            <h4 class="mb-3">{{ project.title }}</h4>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <strong>Beneficiary:</strong>
                                    <span>{{ project.beneficiary.first_name }} {{ project.beneficiary.last_name }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <strong>Goal:</strong>
                                    <span>₹{{ project.funding_goal|floatformat:2|intcomma }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <strong>Tile value:</strong>
                                    <span>₹{{ project.tile_value|floatformat:2|intcomma }}</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <hr class="mt-0 mb-5">

                    <div class="row mb-4">
                        <div class="col-lg-12">
                            <h4 class="mb-3">Order Summary</h4>
                            <div class="bg-light p-3 rounded mb-4">
                                <h5 class="mb-3">Your Order ({{ count }} Tiles)</h5>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-light border-top pt-2">
                                        <strong class="h4 mb-0 text-dark">TOTAL AMOUNT:</strong>
                                        <span class="h3 mb-0 text-success">
                                            <span id="summary-total">₹0.00</span>
                                        </span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <form method="post" id="checkout-form">
                        {% csrf_token %}
                        <input type="hidden" name="project_id" value="{{ project.id }}">
                        <input type="hidden" name="selected_tiles" value="{{ selected_tiles }}">

                        <div class="row g-4">
                            <div class="col-lg-8 col-md-12">
                                <h4 class="mb-3">Your Details</h4>
                                <div class="row g-3">
                                    <div class="col-12 mb-2">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="fullName" name="fname" placeholder="Full Name" required>
                                        </div>
                                        <span class="validation-error text-danger d-block" id="fullName-error"></span>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <div class="form-floating">
                                            <input type="email" class="form-control" id="email" name="email" placeholder="Email Address">
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <div class="form-floating">
                                            <input type="tel" class="form-control" id="phn" name="phn" placeholder="Phone Number" required>
                                        </div>
                                        <span class="validation-error text-danger d-block" id="phn-error"></span>
                                    </div>
                                    <div class="col-md-12 mb-2">
                                        <div class="form-floating">
                                            <textarea class="form-control" id="address" style="height: 100px; resize: none;" name="addr" placeholder="Address" required></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-12 mb-2">
                                        <div class="form-floating">
                                            <textarea class="form-control" id="message" style="height: 100px; resize: none;" name="message" placeholder="Message"></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-start my-2">
                                    <button type="button" id="confirm-button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#confirmCheckoutModal">
                                        Proceed to Confirmation
                                    </button>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-12 text-center d-flex flex-column align-items-center justify-content-center">
                                <h4 class="mb-1">Scan to Pay</h4>
                                <p class="mb-3">
                                    upi id: <strong class="text-dark">{{ ins.default_bank.upi_id }}</strong>
                                </p>
                                <img src="{{ project.qr_code.url }}" class="img-fluid border rounded" alt="QR Code for payment" style="max-width: 200px; height: auto;">
                                <div class="alert alert-info d-grid gap-1 w-100 mt-3" role="alert">
                                    <a id="gpay-link"
                                       href="gpay://upi/pay?pa={{ ins.default_bank.upi_id }}&pn={{ ins.default_bank.account_holder_first_name }} {{ ins.default_bank.account_holder_last_name }}&am=0.00&cu=INR"
                                       class="btn btn-outline-success btn-sm"
                                       target="_blank">
                                        <i class="fab fa-google-pay me-1"></i>Google Pay
                                    </a>
                                    <a id="phonepe-link"
                                       href="phonepe://pay?pa={{ ins.default_bank.upi_id }}&pn={{ payee_name }}&am=0.00&cu=INR"
                                       class="btn btn-outline-primary btn-sm"
                                       target="_blank">
                                        <i class="fas fa-mobile-alt me-1"></i>PhonePe
                                    </a>
                                    <a id="generic-upi-link"
                                       href="upi://pay?pa={{ ins.default_bank.upi_id }}&pn={{ payee_name }}&am=0.00&cu=INR"
                                       class="btn btn-outline-secondary btn-sm mt-1"
                                       target="_blank">
                                        Other UPI Apps
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Total Calculation Logic (Unchanged but cleaned up) ---
            const summaryTotalSpan = document.getElementById('summary-total');
            const modalTotalSpan = document.getElementById('modal-total');

            const tileValue = parseFloat("{{ project.tile_value }}"); // Use unlocalize if necessary to prevent comma issues
            const count = parseInt("{{ count }}");

            const total = tileValue * count;

            const formattedTotal = new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 2,
            }).format(total);

            if (summaryTotalSpan) {
                summaryTotalSpan.textContent = formattedTotal;
            }
            if (modalTotalSpan) {
                modalTotalSpan.textContent = formattedTotal;
            }

            // --- UPI Link Update Logic (Unchanged) ---
            const gpayLink = document.getElementById('gpay-link');
            const phonepeLink = document.getElementById('phonepe-link');
            const genericUpiLink = document.getElementById('generic-upi-link');

            const updateLinkAmount = (linkElement) => {
                if (linkElement) {
                    const currentHref = linkElement.href;
                    // Regex globally replaces 'am=any.number' with 'am=new.number'
                    linkElement.href = currentHref.replace(/&am=[\d\.]+/g, `&am=${total.toFixed(2)}`); // Ensure 2 decimal places
                }
            };

            updateLinkAmount(gpayLink);
            updateLinkAmount(phonepeLink);
            updateLinkAmount(genericUpiLink);


            // --- Form Validation & Submission Logic ---
            const form = document.getElementById('checkout-form');
            const confirmButton = document.getElementById('confirm-button');
            const finalSubmitButton = document.getElementById('final-submit-button');

            // Modal instance (already correctly defined)
            // const confirmModal = new bootstrap.Modal(document.getElementById('confirmCheckoutModal'));

            // Input elements and their corresponding error spans
            const fullNameInput = document.getElementById('fullName');
            const phnInput = document.getElementById('phn');
            const addressInput = document.getElementById('address'); // Added address for explicit check
            const fullNameError = document.getElementById('fullName-error');
            // const lastNameError = document.getElementById('lastName-error'); // Removed: Does not exist in HTML
            const phnError = document.getElementById('phn-error');

            // All required fields for general blank check
            const formInputs = document.querySelectorAll('#checkout-form input[required], #checkout-form textarea[required]');

            // Regex for validation
            // Updated name regex to allow spaces, hyphens, and apostrophes
            const nameRegex = /^[A-Za-z\s.'-]+$/;
            const phoneRegex = /^\d{10}$/;

            // Function to validate a single input with regex (for name and phone)
            function validateInput(input, regex, errorSpan, errorMessage) {
                const trimmedValue = input.value.trim();
                const isValid = regex.test(trimmedValue);

                if (trimmedValue === '') {
                    // Let the generic blank check handle this, or keep for specific feedback
                    errorSpan.textContent = 'This field is required.';
                    input.classList.remove('is-valid');
                    input.classList.add('is-invalid');
                    return false;
                } else if (!isValid) {
                    errorSpan.textContent = errorMessage;
                    input.classList.remove('is-valid');
                    input.classList.add('is-invalid');
                    return false;
                } else {
                    errorSpan.textContent = '';
                    input.classList.remove('is-invalid');
                    input.classList.add('is-valid');
                    return true;
                }
            }

            // Function to validate a field only for being non-blank (e.g., address)
            function validateRequired(input) {
                const trimmedValue = input.value.trim();
                const errorSpan = document.getElementById(input.id + '-error');

                if (trimmedValue === '') {
                    if (errorSpan) {
                         errorSpan.textContent = 'This field is required.';
                    }
                    input.classList.remove('is-valid');
                    input.classList.add('is-invalid');
                    return false;
                } else {
                     if (errorSpan) {
                        errorSpan.textContent = '';
                    }
                    input.classList.remove('is-invalid');
                    input.classList.add('is-valid');
                    return true;
                }
            }


            // Function to validate all fields and update the main button
            function validateForm() {
                let isValid = true;

                // 1. Specific Regex Validation
                // CORRECTED MESSAGE: reflects full name validation
                isValid = validateInput(fullNameInput, nameRegex, fullNameError, 'Name can only contain letters, spaces, hyphens, or apostrophes.') && isValid;
                isValid = validateInput(phnInput, phoneRegex, phnError, 'Phone number must be a 10-digit number.') && isValid;

                // 2. Generic Blank Validation for all required fields (Address, Email, etc.)
                formInputs.forEach(input => {
                    if (input.id !== 'fullName' && input.id !== 'phn') { // Skip fields already checked by validateInput
                        // Check required status of other fields and update classes
                        if (input.value.trim() === '') {
                            input.classList.remove('is-valid');
                            input.classList.add('is-invalid');
                            isValid = false;
                        } else {
                            input.classList.remove('is-invalid');
                            input.classList.add('is-valid');
                        }
                    }
                });

                // Re-check for address separately, as it had no specific error span in HTML
                // If you want an error message for address, you need to add an error span for it in the HTML

                return isValid;
            }

            // Listen for input on all required fields
            formInputs.forEach(input => {
                input.addEventListener('input', () => {
                    const isFormValid = validateForm();
                    // Enable/Disable the confirm button based on current validation state
                    confirmButton.disabled = !isFormValid;
                });
            });

            // Set the initial state of the button
            confirmButton.disabled = !validateForm();

            // Prevent form submission if the button is clicked but validation fails (a final safeguard)
            confirmButton.addEventListener('click', function(e) {
                if (!validateForm()) {
                    e.preventDefault();
                    // Optionally scroll to the first error
                    const firstInvalid = document.querySelector('.is-invalid');
                    if (firstInvalid) firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });


            // Event listener for the final submit button in the modal
            finalSubmitButton.addEventListener('click', function() {
                // Re-validate just before final submission (security check)
                if (validateForm()) {
                    finalSubmitButton.disabled = true;
                    finalSubmitButton.textContent = 'Submitting...';
                    form.submit();
                } else {
                    // Should not happen if confirmButton is disabled correctly, but safe to check
                    alert("Please correct the validation errors before proceeding.");
                    confirmModal.hide();
                }
            });
        });
    </script>

{% endblock %}