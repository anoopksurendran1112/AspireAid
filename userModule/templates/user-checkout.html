{% extends 'index.html' %}
{% load static %}
{% load humanize %}
{% block content %}

    <div class="modal fade" id="confirmCheckoutModal" tabindex="-1" aria-labelledby="confirmCheckoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmCheckoutModalLabel"><strong>Confirm and Redirect</strong></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">x</button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to proceed? Your selected tiles will be reserved, and you will be redirected to the project page.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="final-submit-button">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <section class="project-area section-gap" id="project">
        <div class="container">
            <div class="card data-card">
                <div class="card-header text-center">
                    <h1 class="my-2"><strong>Checkout</strong></h1>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <h4 class="mb-3">Project Details</h4>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <strong>Title:</strong>
                                    <span>{{ project.title }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <strong>Goal:</strong>
                                    <span>₹{{ project.funding_goal|floatformat:2|intcomma }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <strong>Created by:</strong>
                                    <span>{{ project.created_by.email }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <strong>Created on:</strong>
                                    <span>{{ project.created_at|date:"F d, Y" }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <strong>Closing by:</strong>
                                    <span>{{ project.closing_date|date:"F d, Y" }}</span>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6 mb-4">
                            <h4 class="mb-3">Beneficiary Details</h4>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <strong>Name:</strong>
                                    <span>{{ project.beneficiary.first_name }} {{ project.beneficiary.last_name }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <strong>Age:</strong>
                                    <span>{{ project.beneficiary.age }} years old</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <strong>Phone:</strong>
                                    <span>+91-{{ project.beneficiary.phone_number }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <strong>Address:</strong>
                                    <span>{{ project.beneficiary.address }}</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="row">
                        <div class="col-lg-12">
                            <h4 class="mb-3">Order Summary</h4>
                            <div class="table-responsive mb-4">
                                <table class="table table-striped align-middle mb-0">
                                    <thead class="bg-dark text-white">
                                        <tr>
                                            <th>Selected Tiles</th>
                                            <th>Tile Value</th>
                                            <th>Quantity</th>
                                            <th class="text-end">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody data-tile-value="{{ project.tile_value }}" data-count="{{ count }}">
                                        <tr>
                                            <td>
                                                <h6 class="text-truncate font-size-14 mb-1">{{ selected_tiles }}</h6>
                                            </td>
                                            <td>₹{{ project.tile_value|floatformat:2|intcomma }}</td>
                                            <td>{{ count }}</td>
                                            <td class="text-end">
                                                <span id="calculated-total">₹0</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <form method="post" id="checkout-form">
                        {% csrf_token %}
                        <input type="hidden" name="project_id" value="{{ project.id }}">
                        <input type="hidden" name="selected_tiles" value="{{ selected_tiles }}">

                        <div class="row g-4">
                            <div class="col-xl-8 col-lg-12">
                                <h4 class="mb-3">Your Details</h4>
                                <div class="row g-3">
                                    <div class="col-md-6 mb-2">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="firstName" name="fname" placeholder="First Name" required>
                                        </div>
                                        <span class="validation-error text-danger d-block" id="firstName-error"></span>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="lastName" name="lname" placeholder="Last Name" required>
                                        </div>
                                        <span class="validation-error text-danger d-block" id="lastName-error"></span>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <div class="form-floating">
                                            <input type="email" class="form-control" id="email" name="email" placeholder="Email Address">
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <div class="form-floating">
                                            <input type="tel" class="form-control" id="phn" name="phn" placeholder="Phone Number" required>
                                        </div>
                                        <span class="validation-error text-danger d-block" id="phn-error"></span>
                                    </div>
                                    <div class="col-md-12 mb-2">
                                        <div class="form-floating">
                                            <textarea class="form-control" id="address" style="height: 100px; resize: none;" name="addr" placeholder="Address" required></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-12 mb-2">
                                        <div class="form-floating">
                                            <textarea class="form-control" id="message" style="height: 100px; resize: none;" name="message" placeholder="Message"></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-start my-2">
                                    <button type="button" id="confirm-button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#confirmCheckoutModal">
                                        Proceed to Confirmation
                                    </button>
                                </div>
                            </div>
                            <div class="col-xl-4 col-lg-12 text-center d-flex flex-column align-items-center justify-content-center">
                                <h4 class="mb-3">Scan to Pay</h4>
                                <img src="{{ project.qr_code.url }}" class="img-fluid border rounded" alt="QR Code for payment">
                                <div class="alert alert-info mt-3" role="alert">
                                    Scan the QR code with your UPI app to complete the payment.
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Total Calculation Logic ---
        const totalSpan = document.getElementById('calculated-total');
        const tbody = document.querySelector('tbody');

        // Read the data attributes and convert them to numbers
        const tileValue = parseFloat(tbody.dataset.tileValue);
        const count = parseInt(tbody.dataset.count);

        // Calculate the total and update the span
        const total = tileValue * count;
        if (totalSpan) {
            totalSpan.textContent = `₹${total.toFixed(2)}`;
        }

        // --- Form Validation & Submission Logic ---
        const form = document.getElementById('checkout-form');
        const confirmButton = document.getElementById('confirm-button');
        const finalSubmitButton = document.getElementById('final-submit-button');

        // Modal instance
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmCheckoutModal'));

        // Input elements and their corresponding error spans
        const firstNameInput = document.getElementById('firstName');
        const lastNameInput = document.getElementById('lastName');
        const phnInput = document.getElementById('phn');
        const firstNameError = document.getElementById('firstName-error');
        const lastNameError = document.getElementById('lastName-error');
        const phnError = document.getElementById('phn-error');
        const formInputs = document.querySelectorAll('#checkout-form input[required], #checkout-form textarea[required]');

        // Regex for validation
        const nameRegex = /^[A-Za-z\s]+$/;
        const phoneRegex = /^\d{10}$/;

        // Function to validate a single input
        function validateInput(input, regex, errorSpan, errorMessage) {
            const trimmedValue = input.value.trim();
            const isValid = regex.test(trimmedValue);

            if (trimmedValue === '') {
                errorSpan.textContent = 'This field is required.';
                input.classList.remove('is-valid');
                input.classList.add('is-invalid');
                return false;
            } else if (!isValid) {
                errorSpan.textContent = errorMessage;
                input.classList.remove('is-valid');
                input.classList.add('is-invalid');
                return false;
            } else {
                errorSpan.textContent = '';
                input.classList.remove('is-invalid');
                input.classList.add('is-valid');
                return true;
            }
        }

        // Function to validate all fields and update the main button
        function validateForm() {
            let isValid = true;
            isValid = validateInput(firstNameInput, nameRegex, firstNameError, 'First name can only contain letters.') && isValid;
            isValid = validateInput(lastNameInput, nameRegex, lastNameError, 'Last name can only contain letters.') && isValid;
            isValid = validateInput(phnInput, phoneRegex, phnError, 'Phone number must be a 10-digit number.') && isValid;

            // Check if all required fields (including textarea) are filled
            const allFieldsFilled = Array.from(formInputs).every(input => input.value.trim() !== '');

            return isValid && allFieldsFilled;
        }

        // Listen for input on all required fields
        formInputs.forEach(input => {
            input.addEventListener('input', () => {
                const isFormValid = validateForm();
                confirmButton.disabled = !isFormValid;
            });
        });

        // Set the initial state of the button
        confirmButton.disabled = !validateForm();

        // Event listener for the final submit button in the modal
        finalSubmitButton.addEventListener('click', function() {
            // Disable the button to prevent double-submission
            finalSubmitButton.disabled = true;
            finalSubmitButton.textContent = 'Submitting...';

            // Submit the form
            form.submit();
        });
    });
</script>

{% endblock %}