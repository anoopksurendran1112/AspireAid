{% extends 'index.html' %}
{% load static %}
{% load humanize %}
{% block content %}

    <div class="modal fade" id="confirmCheckoutModal" tabindex="-1" aria-labelledby="confirmCheckoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title fw-bold text-dark" id="confirmCheckoutModalLabel">Confirm and Proceed to Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-0">
                    <p class="text-secondary">By confirming, your selected tiles will be **reserved**, and your transaction will be finalized upon successful payment. Please ensure your details are correct.</p>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0 fw-bold text-dark">Total Payable:</h4>
                        <span class="h3 mb-0 text-success fw-bolder" id="modal-total">₹0.00</span>
                    </div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary fw-bold" id="final-submit-button">
                        <i class="bi bi-shield-lock me-1"></i> Final Confirmation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <section class="py-5 mt-5">
        <div class="container py-5">
            <div class="card border-0 rounded-1 shadow-lg">
                <div class="card-header text-center bg-dark text-white rounded-top-4 py-3">
                    <h1 class="h3 mb-0 fw-bolder">Project Checkout</h1>
                </div>
                <div class="card-body p-4 p-md-5">
                    <div class="row">

                        <div class="col-lg-7 col-md-12">
                            <form method="post" id="checkout-form" novalidate>
                                {% csrf_token %}
                                <input type="hidden" name="project_id" value="{{ project.id }}">
                                <input type="hidden" name="selected_tiles" value="{{ selected_tiles }}">

                                <h4 class="fw-bold text-dark mb-4 border-bottom pb-2">Project Details</h4>
                                <h5 class="mb-3 fw-semibold text-primary">{{ project.title }}</h5>
                                <ul class="list-group list-group-flush mb-5">
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-white">
                                        <strong>Beneficiary:</strong>
                                        <span class="fw-semibold">{{ project.beneficiary.first_name }} {{ project.beneficiary.last_name }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-white">
                                        <strong>Funding Goal:</strong>
                                        <span>₹{{ project.funding_goal|floatformat:2|intcomma }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-white">
                                        <strong>Tile Value:</strong>
                                        <span>₹{{ project.tile_value|floatformat:2|intcomma }}</span>
                                    </li>
                                </ul>

                                <h4 class="fw-bold text-dark mb-4 border-bottom pb-2">Your Details</h4>
                                <div class="row g-4">
                                    <div class="col-12">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="fullName" name="fname" placeholder="Full Name" required>
                                            <label for="fullName">Full Name</label>
                                        </div>
                                        <div class="validation-error text-danger small mt-1" id="fullName-error"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input type="email" class="form-control" id="email" name="email" placeholder="Email Address">
                                            <label for="email">Email Address</label>
                                        </div>
                                        <div class="form-text text-muted small mt-1">*Optional: Used for transaction receipts.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input type="tel" class="form-control" id="phn" name="phn" placeholder="Phone Number" required maxlength="10">
                                            <label for="phn">Phone Number (10 digits)</label>
                                        </div>
                                        <div class="validation-error text-danger small mt-1" id="phn-error"></div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-floating">
                                            <textarea class="form-control" id="address" style="height: 100px; resize: none;" name="addr" placeholder="Address" required></textarea>
                                            <label for="address">Full Address</label>
                                        </div>
                                        <div class="validation-error text-danger small mt-1" id="address-error"></div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-start mt-5">
                                    <button type="button" id="confirm-button" class="btn btn-primary btn-lg fw-bold rounded-pill px-5" data-bs-toggle="modal" data-bs-target="#confirmCheckoutModal" disabled>
                                        <i class="bi bi-check-circle me-2"></i> Review & Confirm
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="col-lg-5 col-md-12 mt-5 mt-lg-0">

                            <div class="p-4 rounded-4 bg-light shadow-sm" >
                                <h4 class="fw-bold text-dark mb-4 border-bottom pb-2">Order Summary</h4>
                                <p class="lead fw-semibold mb-3">Selected Tiles: <span class="text-primary">{{ selected_tiles }}</span></p>
                                <p class="lead fw-semibold">Total Tiles: <span class="text-primary">{{ count }}</span></p>

                                <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                                    <strong class="h4 mb-0 text-dark">TOTAL AMOUNT:</strong>
                                    <span class="h3 mb-0 text-success fw-bolder">
                                        <span id="summary-total">₹0.00</span>
                                    </span>
                                </div>
                            </div>

                            <div class="p-4 rounded-4 bg-white shadow-sm mt-4 text-center">
                                <h4 class="mb-3 fw-bold">Scan or Pay via UPI</h4>

                                <img src="{% static 'Custom-styles/Frontend/img/project_1_qr.png' %}" class="img-fluid border rounded-3 mb-3 shadow-sm" alt="QR Code for payment" style="max-width: 200px; height: auto;">
                                <p class="mb-3 small text-muted">
                                    UPI ID: <strong class="text-dark">{{ ins.default_bank.upi_id }}</strong>
                                </p>

                                <div class="d-flex justify-content-center align-items-center gap-3 w-100 mx-auto upi-icon-row">

                                    <a id="gpay-link" href="gpay://upi/pay?pa={{ ins.default_bank.upi_id }}&pn={{ ins.default_bank.account_holder_first_name }} {{ ins.default_bank.account_holder_last_name }}&am=0.00&cu=INR"
                                       class="btn btn-lg btn-success text-white upi-icon-btn" title="Pay with Google Pay" target="_blank">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-google" viewBox="0 0 16 16">
                                          <path d="M15.545 6.558a9.4 9.4 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.7 7.7 0 0 1 5.352 2.082l-2.284 2.284A4.35 4.35 0 0 0 8 3.166c-2.087 0-3.86 1.408-4.492 3.304a4.8 4.8 0 0 0 0 3.063h.003c.635 1.893 2.405 3.301 4.492 3.301 1.078 0 2.004-.276 2.722-.764h-.003a3.7 3.7 0 0 0 1.599-2.431H8v-3.08z"/>
                                        </svg>
                                    </a>

                                    <a id="phonepe-link"
                                       href="phonepe://pay?pa={{ ins.default_bank.upi_id }}&pn={{ payee_name }}&am=0.00&cu=INR"
                                       class="btn btn-lg btn-primary upi-icon-btn"
                                       title="Pay with PhonePe"
                                       target="_blank">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-phone" viewBox="0 0 16 16">
                                          <path d="M11 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM5 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
                                          <path d="M8 14a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/>
                                        </svg>
                                    </a>

                                    <a id="generic-upi-link"
                                       href="upi://pay?pa={{ ins.default_bank.upi_id }}&pn={{ payee_name }}&am=0.00&cu=INR"
                                       class="btn btn-lg btn-secondary upi-icon-btn"
                                       title="Pay with Other UPI App"
                                       target="_blank">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cash-coin" viewBox="0 0 16 16">
                                          <path fill-rule="evenodd" d="M11 15a4 4 0 1 0 0-8 4 4 0 0 0 0 8m5-4a5 5 0 1 1-10 0 5 5 0 0 1 10 0"/>
                                          <path d="M9.438 11.944c.047.596.518 1.06 1.363 1.116v.44h.375v-.443c.875-.061 1.386-.529 1.386-1.207 0-.618-.39-.936-1.09-1.1l-.296-.07v-1.2c.376.043.614.248.671.532h.658c-.047-.575-.54-1.024-1.329-1.073V8.5h-.375v.45c-.747.073-1.255.522-1.255 1.158 0 .562.378.92 1.007 1.066l.248.061v1.272c-.384-.058-.639-.27-.696-.563h-.668zm1.36-1.354c-.369-.085-.569-.26-.569-.522 0-.294.216-.514.572-.578v1.1zm.432.746c.449.104.655.272.655.569 0 .339-.257.571-.709.614v-1.195z"/>
                                          <path d="M1 0a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h4.083q.088-.517.258-1H3a2 2 0 0 0-2-2V3a2 2 0 0 0 2-2h10a2 2 0 0 0 2 2v3.528c.38.34.717.728 1 1.154V1a1 1 0 0 0-1-1z"/>
                                          <path d="M9.998 5.083 10 5a2 2 0 1 0-3.132 1.65 6 6 0 0 1 3.13-1.567"/>
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get necessary elements
            const summaryTotalSpan = document.getElementById('summary-total');
            const modalTotalSpan = document.getElementById('modal-total');
            const form = document.getElementById('checkout-form');
            const confirmButton = document.getElementById('confirm-button');
            const finalSubmitButton = document.getElementById('final-submit-button');

            // --- 1. Total Calculation and Display ---
            const tileValue = parseFloat("{{ project.tile_value }}");
            const count = parseInt("{{ count }}");
            const total = tileValue * count;

            const formattedTotal = new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 2,
            }).format(total);

            // Update display spans
            if (summaryTotalSpan) summaryTotalSpan.textContent = formattedTotal;
            if (modalTotalSpan) modalTotalSpan.textContent = formattedTotal;

            // --- 2. UPI Link Update Logic ---
            const upiLinks = document.querySelectorAll('#gpay-link, #phonepe-link, #generic-upi-link');

            upiLinks.forEach(linkElement => {
                const currentHref = linkElement.href;
                // Regex globally replaces 'am=any.number' with 'am=new.number'
                linkElement.href = currentHref.replace(/&am=[\d\.]+/g, `&am=${total.toFixed(2)}`);
            });


            // --- 3. Form Validation Logic ---
            const fullNameInput = document.getElementById('fullName');
            const phnInput = document.getElementById('phn');
            const addressInput = document.getElementById('address');

            // Error spans (using new IDs that match the input IDs + '-error')
            const fullNameError = document.getElementById('fullName-error');
            const phnError = document.getElementById('phn-error');
            const addressError = document.getElementById('address-error');

            const requiredInputs = [
                { input: fullNameInput, error: fullNameError, regex: /^[A-Za-z\s.'-]+$/, msg: 'Name can only contain letters, spaces, hyphens, or apostrophes.' },
                { input: phnInput, error: phnError, regex: /^\d{10}$/, msg: 'Phone number must be exactly 10 digits.' },
                { input: addressInput, error: addressError, regex: /.+/, msg: 'Address is required.' } // Simple check for non-empty
            ];

            // Helper function to validate a single field
            function validateField(field) {
                const trimmedValue = field.input.value.trim();
                let isValid = field.regex.test(trimmedValue);

                if (trimmedValue === '' || !isValid) {
                    // Display error message
                    field.error.textContent = (trimmedValue === '') ? 'This field is required.' : field.msg;
                    field.input.classList.remove('is-valid');
                    field.input.classList.add('is-invalid');
                    return false;
                } else {
                    // Valid state
                    field.error.textContent = '';
                    field.input.classList.remove('is-invalid');
                    field.input.classList.add('is-valid');
                    return true;
                }
            }

            // Function to validate the entire form
            function validateForm() {
                let isFormValid = true;
                requiredInputs.forEach(field => {
                    // The '&& isFormValid' pattern ensures we check ALL fields but the result is only true if ALL are true
                    isFormValid = validateField(field) && isFormValid;
                });
                return isFormValid;
            }

            // Event listener for real-time validation feedback
            requiredInputs.forEach(field => {
                field.input.addEventListener('input', () => {
                    validateField(field); // Validate the field actively being typed in
                    confirmButton.disabled = !validateForm(); // Update modal button state
                });
            });

            // Set initial state of the button on load
            confirmButton.disabled = !validateForm();


            // Event listener for the final submit button in the modal
            finalSubmitButton.addEventListener('click', function() {
                if (validateForm()) {
                    // Disable and change text to prevent double submission
                    finalSubmitButton.disabled = true;
                    finalSubmitButton.textContent = 'Processing...';

                    // Submit the actual form
                    form.submit();
                } else {
                    // If validation somehow fails here (shouldn't happen if confirmButton is managed), close modal and alert user
                    alert("Please correct the highlighted errors before confirming payment.");
                    // Use Bootstrap's native method to hide the modal
                    const modalInstance = bootstrap.Modal.getInstance(document.getElementById('confirmCheckoutModal'));
                    if (modalInstance) modalInstance.hide();
                }
            });
        });
    </script>
{% endblock %}