{% extends 'admin-dashboard.html' %}
{% block content %}
{% load humanize %}

<!---------------------- Modal for Adding new Institution -------------------->
    <div class="modal fade" id="ModalAddProject" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel"><strong>Add a new Project</strong></h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <form method="post" id="create-project-form" action="{% url 'admin_add_project' %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-lg-6 px-3">
                                <h3 class="card-title my-2 text-black">Project Details</h3>
                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="form-floating mb-2">
                                            <input type="text" class="form-control" id="projectTitle" placeholder="Enter the project title.. " name="title" required>
                                            <label for="projectTitle">Project Title</label>
                                            <span class="text-danger" id="projectTitle-error"></span>
                                        </div>
                                    </div>
                                    <div class="col-lg-12">
                                        <div class="form-floating mb-2">
                                            <input type="number" class="form-control" id="fundingGoal" placeholder="Enter the funding goal.. " name="goal" required>
                                            <label for="fundingGoal">Funding Goal</label>
                                            <span class="text-danger" id="fundingGoal-error"></span>
                                        </div>
                                    </div>
                                    <div class="col-lg-12">
                                        <div class="form-floating mb-2">
                                            <input type="number" class="form-control" id="tileValue" placeholder="Enter tile value " name="tvalue" required>
                                            <label for="tileValue">Single Tile Value</label>
                                            <span class="text-danger" id="tileValue-error"></span>
                                        </div>
                                    </div>
                                    <div class="col-lg-12">
                                        <div class="form-floating mb-2">
                                            <textarea class="form-control" id="projectDesc" style="resize:none; height:75px;" placeholder="Enter the description..." name="desc" required></textarea>
                                            <label for="projectDesc">Project Description</label>
                                            <span class="text-danger" id="projectDesc-error"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 px-3">
                                <h3 class="card-title my-2 text-black">Beneficiary Details</h3>
                                <div class="row">
                                    <div class="col-lg-6">
                                        <div class="form-floating mb-2">
                                            <input type="text" class="form-control" id="fname" placeholder="Enter Firstname" name="fname" required>
                                            <label for="fname">First Name</label>
                                            <span class="text-danger" id="fname-error"></span>
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="form-floating mb-2">
                                            <input type="text" class="form-control" id="lname" placeholder="Enter Lastname" name="lname" required>
                                            <label for="lname">Last Name</label>
                                            <span class="text-danger" id="lname-error"></span>
                                        </div>
                                    </div>
                                    <div class="col-lg-12">
                                        <div class="form-floating mb-2">
                                            <input type="number" class="form-control" id="age" placeholder="Enter Age " name="age" required>
                                            <label for="age">Enter Age</label>
                                            <span class="text-danger" id="age-error"></span>
                                        </div>
                                    </div>
                                    <div class="col-lg-12">
                                        <div class="form-floating mb-2">
                                            <input type="tel" class="form-control" id="telPhn" placeholder="Enter Phone Number.. " name="phn" required>
                                            <label for="telPhn">Phone Number</label>
                                            <span class="text-danger" id="telPhn-error"></span>
                                        </div>
                                    </div>
                                    <div class="col-lg-12">
                                        <div class="form-floating mb-2">
                                            <textarea class="form-control" style="resize:none; height:75px;" id="address" placeholder="Enter your Address.." name="addr" required></textarea>
                                            <label for="address">Address</label>
                                            <span class="text-danger" id="address-error"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer d-flex justify-content-between">
                        <button type="reset" class="btn btn-danger" data-bs-dismiss="modal">Reset & Close</button>
                        <button type="submit" class="btn btn-success">Add</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<!---------------------- All Institution Table Details -------------------->
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4 fw-bold">Project Details</h1>

            <div class="card border-0 shadow-lg rounded-4 flex-fill">

                <div class="card-header bg-white rounded-top-4 border-0 d-flex justify-content-end align-items-center p-4">

                    {% if not admin.is_superuser %}
                        <button type="button" class="btn btn-info fw-semibold rounded-pill py-2 px-3 me-3" data-bs-toggle="modal" data-bs-target="#ModalAddProject"
                                {% if not admin.institution.default_bank %} disabled {% endif %}
                                title="{% if not admin.institution.default_bank %} Please set default bank details first. {% endif %}">
                            <i class="align-middle me-1" data-feather="folder-plus"></i> Add New Project
                        </button>
                    {% endif %}

                    <button type="button" class="btn btn-primary fw-semibold rounded-pill py-2 px-3"
                        data-bs-toggle="offcanvas"
                        data-bs-target="#offcanvasProjectFilter"
                        aria-controls="offcanvasProjectFilter">
                        <i class="align-middle me-1" data-feather="filter"></i> Advanced Filter
                    </button>
                </div>

                <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasProjectFilter" aria-labelledby="offcanvasProjectFilterLabel">
                    <div class="offcanvas-header border-bottom">
                        <h5 class="offcanvas-title fw-bold" id="offcanvasProjectFilterLabel">
                            <i class="align-middle me-2" data-feather="filter"></i> Filter Projects
                        </h5>
                        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                    </div>
                    <div class="offcanvas-body">
                        <form method="get" class="row g-3 align-items-end">

                            <div class="col-12">
                                <h6 class="mt-0 mb-3 fw-bold text-dark">Search & Status</h6>
                            </div>

                            <div class="col-12">
                                <label for="project_title" class="form-label small text-muted mb-1">Project Name</label>
                                <input type="text" class="form-control" id="project_title" name="project_title" placeholder="Enter Project Name">
                            </div>
                            <div class="col-12">
                                <label for="project_status" class="form-label small text-muted mb-1">Project Status</label>
                                <select id="project_status" name="project_status" class="form-select">
                                    <option value="">All Projects</option>
                                    <option value="active">Active Projects</option>
                                    <option value="closed">Closed Projects</option>
                                    <option value="success">Successful Projects</option>
                                </select>
                            </div>

                            <div class="col-12 mt-4">
                                <h6 class="mb-3 fw-bold text-dark">Date Range</h6>
                            </div>

                            <div class="col-md-6">
                                <label for="start_date" class="form-label small text-muted mb-1">Created From</label>
                                <input type="date" class="form-control" id="start_date" name="start_date">
                            </div>
                            <div class="col-md-6">
                                <label for="end_date" class="form-label small text-muted mb-1">Created To</label>
                                <input type="date" class="form-control" id="end_date" name="end_date">
                            </div>

                            <div class="col-12 mt-4">
                                <h6 class="mb-3 fw-bold text-dark">Sorting Options</h6>
                            </div>

                            <div class="col-md-6">
                                <label for="order_by_target" class="form-label small text-muted mb-1">Sort by Target</label>
                                <select id="order_by_target" name="target_order" class="form-select">
                                    <option value="">None</option>
                                    <option value="asc">Ascending</option>
                                    <option value="desc">Descending</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="order_by_current_amount" class="form-label small text-muted mb-1">Sort by Current</label>
                                <select id="order_by_current_amount" name="amount_order" class="form-select">
                                    <option value="">None</option>
                                    <option value="asc">Ascending</option>
                                    <option value="desc">Descending</option>
                                </select>
                            </div>

                            <div class="col-12 text-end mt-4 pt-3 border-top">
                                <button type="submit" class="btn btn-primary fw-semibold rounded-pill py-2 px-3 w-100 mb-2">
                                    <i class="align-middle me-1" data-feather="check"></i> Apply Filters
                                </button>
                                <a href="." class="btn btn-outline-secondary fw-semibold rounded-pill py-2 px-3 w-100">
                                    <i class="align-middle me-1" data-feather="x"></i> Clear Filters
                                </a>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-borderless align-middle mb-0">

                            <thead class="table-dark">
                                <tr>
                                    <th class="text-white small fw-bold text-uppercase ps-4">#</th>
                                    <th class="text-white small fw-bold text-uppercase">Project Title</th>
                                    <th class="d-none d-lg-table-cell text-white small fw-bold text-uppercase">Target</th>
                                    <th class="text-white small fw-bold text-uppercase">Current Amount</th>
                                    <th class="d-none d-md-table-cell text-white small fw-bold text-uppercase">Created</th>
                                    <th class="text-white small fw-bold text-uppercase">Status</th>
                                    <th class="text-center text-white small fw-bold text-uppercase pe-4">Action</th>
                                </tr>
                            </thead>

                            <tbody>
                            {% for p in prj %}
                                <tr>
                                    <td class="ps-4">{{ forloop.counter }}</td>

                                    <td class="fw-semibold text-dark">
                                        {{ p.title|truncatechars:35 }}
                                    </td>

                                    <td class="d-none d-lg-table-cell text-nowrap">₹{{ p.funding_goal|floatformat:2|intcomma }}</td>

                                    <td class="fw-bold text-nowrap">₹{{ p.current_amount|floatformat:2|intcomma }}</td>

                                    <td class="d-none d-md-table-cell">{{ p.started_at|date:"d M, Y" }}</td>

                                    <td>
                                        {% if p.validity %}
                                            <span class="badge bg-success bg-opacity-10 text-success fw-bold rounded-pill p-2">
                                                <i class="align-middle me-1" data-feather="check-square"></i> Completed
                                            </span>
                                            <small class="d-block text-muted small mt-1">On {{ p.closed_by|date:"d M, Y" }}</small>
                                        {% elif p.table_status == False %}
                                            <span class="badge bg-danger bg-opacity-10 text-danger fw-bold rounded-pill p-2">
                                                <i class="align-middle me-1" data-feather="lock"></i> Closed
                                            </span>
                                            <small class="d-block text-muted small mt-1">Manually stopped</small>
                                        {% else %}
                                            <span class="badge bg-info bg-opacity-10 text-info fw-bold rounded-pill p-2">
                                                <i class="align-middle me-1" data-feather="activity"></i> Ongoing
                                            </span>
                                        {% endif %}
                                    </td>

                                    <td class="text-center pe-4">
                                        <a class="btn btn-sm btn-info rounded-pill px-3" href="/administrator/single-project/{{ p.id }}/" title="View Project Details">
                                            <i class="align-middle" data-feather="eye"></i>
                                        </a>
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center p-5">
                                        <div class="alert alert-warning m-0 rounded-3" role="alert">
                                            No projects were found matching the criteria.
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        {% if messages %}
            {% for message in messages %}
                Swal.fire({
                    title: '{{ message.tags|title }}!',
                    text: '{{ message }}',
                    icon: '{{ message.tags }}',
                    confirmButtonText: 'OK'
                });
            {% endfor %}
        {% endif %}
    </script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('create-project-form');

        // Define all input elements
        const projectTitleInput = document.getElementById('projectTitle');
        const fundingGoalInput = document.getElementById('fundingGoal');
        const tileValueInput = document.getElementById('tileValue');
        const closingDateInput = document.getElementById('closingDate');
        const projectDescInput = document.getElementById('projectDesc');
        const fnameInput = document.getElementById('fname');
        const lnameInput = document.getElementById('lname');
        const ageInput = document.getElementById('age');
        const phoneInput = document.getElementById('telPhn');
        const addressInput = document.getElementById('address');

        // Regex patterns for validation
        const phoneRegex = /^\d{10}$/;
        const nameRegex = /^[a-zA-Z\s]+$/;

        function updateValidationStatus(inputElement, isValid, errorMessage = "") {
            const errorSpan = document.getElementById(`${inputElement.id}-error`);
            if (isValid) {
                inputElement.classList.remove('is-invalid');
                inputElement.classList.add('is-valid');
                if (errorSpan) errorSpan.textContent = "";
            } else {
                inputElement.classList.remove('is-valid');
                inputElement.classList.add('is-invalid');
                if (errorSpan) errorSpan.textContent = errorMessage;
            }
        }

        function validateForm() {
            let formIsValid = true;

            // 1. Validate all required fields
            const requiredInputs = form.querySelectorAll('[required]');
            requiredInputs.forEach(input => {
                if (input.value.trim() === '') {
                    updateValidationStatus(input, false, "This field is required.");
                    formIsValid = false;
                } else {
                    updateValidationStatus(input, true);
                }
            });

            // 2. Validate specific fields with custom rules

            // Validate First and Last Name
            if (fnameInput.value.trim() !== '' && !nameRegex.test(fnameInput.value)) {
                updateValidationStatus(fnameInput, false, "Must contain only letters and spaces.");
                formIsValid = false;
            }
            if (lnameInput.value.trim() !== '' && !nameRegex.test(lnameInput.value)) {
                updateValidationStatus(lnameInput, false, "Must contain only letters and spaces.");
                formIsValid = false;
            }

            // Validate Phone Number
            if (phoneInput.value.trim() !== '' && !phoneRegex.test(phoneInput.value)) {
                updateValidationStatus(phoneInput, false, "Please enter a valid 10-digit phone number.");
                formIsValid = false;
            }

            // Validate Closing Date (must be in the future)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const closingDate = new Date(closingDateInput.value);

            if (closingDateInput.value.trim() !== '' && (isNaN(closingDate.getTime()) || closingDate <= today)) {
                updateValidationStatus(closingDateInput, false, "The closing date must be in the future.");
                formIsValid = false;
            }

            // Validate Funding Goal and Tile Value
            const fundingGoal = parseFloat(fundingGoalInput.value);
            const tileValue = parseFloat(tileValueInput.value);

            if (fundingGoalInput.value.trim() !== '' && (isNaN(fundingGoal) || fundingGoal <= 0)) {
                updateValidationStatus(fundingGoalInput, false, "Must be a positive number.");
                formIsValid = false;
            }

            if (!isNaN(fundingGoal) && fundingGoal > 10000000) {
                updateValidationStatus(fundingGoalInput, false, "Funding goal cannot exceed 1 Crore (10,000,000).");
                formIsValid = false;
            }

            if (tileValueInput.value.trim() !== '' && (isNaN(tileValue) || tileValue <= 0)) {
                updateValidationStatus(tileValueInput, false, "Must be a positive number.");
                formIsValid = false;
            }

            if (!isNaN(fundingGoal) && !isNaN(tileValue) && fundingGoal <= tileValue) {
                updateValidationStatus(fundingGoalInput, false, "Goal must be greater than tile value.");
                updateValidationStatus(tileValueInput, false, "Goal must be greater than tile value.");
                formIsValid = false;
            }

            // Validate Age
            const age = parseInt(ageInput.value);
            if (ageInput.value.trim() !== '' && (isNaN(age) || age < 1 || age > 150)) {
                updateValidationStatus(ageInput, false, "Please enter a valid age.");
                formIsValid = false;
            }

            return formIsValid;
        }

        // Add the submit event listener to run validation
        form.addEventListener('submit', (event) => {
            const formIsValid = validateForm();
            if (!formIsValid) {
                event.preventDefault(); // Stop form submission if validation fails
            }
        });
    });
</script>

{% endblock %}